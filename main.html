<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>自主装机报价系统</title>
    <script src="js/jquery-3.1.1.js"></script>
    <script src="js/bootstrap.js"></script>
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/home.css">
    <script src="js/home.js"></script>
    <script src="js/my.js"></script>
</head>
<style>
    img {
        width: 32px;
        height: 32px;
    }
</style>
<body>
<nav class="navbar navbar-default " role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <a class="navbar-brand" href="main.html">自主装机报价系统</a>
        </div>
        <div>
            <ul class="nav navbar-nav">
                <li class="active"><a href="main.html">首页</a></li>
                <li><a href="bbs.html">论坛</a></li>
            </ul>
        </div>
        <div>
            <!--向左对齐-->
            <ul class="nav navbar-nav navbar-left">

            </ul>
            <!--向右对齐-->
            <form id="navbar_form" class="navbar-form navbar-right" role="search">
                <!--<a class="btn btn-default" href="register.html">-->
                <!--注册-->
                <!--</a>-->
                <!--<a class="btn btn-default" href="login.html">-->
                <!--登录-->
                <!--</a>-->
            </form>
        </div>
    </div>
</nav>
<div class="container">
    <div class="row">
        <div id="myCarousel" class="carousel slide">
            <!-- 轮播（Carousel）指标 -->
            <ol id="carouselIndicators" class="carousel-indicators">

            </ol>
            <!-- 轮播（Carousel）项目 -->
            <div id="carouselInner" class="carousel-inner">
                <div class="item active">

                </div>
            </div>
            <!-- 轮播（Carousel）导航 -->
            <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
                <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                <span class="sr-only">Previous</span>
            </a>
            <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
                <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                <span class="sr-only">Next</span>
            </a>
        </div>
    </div>
    <div class="row">.</div>
    <div class="row">
        <div class="col-sm-5">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        购物车
                    </h3>
                </div>
                <div class="list-group">
                    <a href="#" class="list-group-item" onclick="go('CPU')">
                        <h4 class="list-group-item-heading">
                            CPU
                        </h4>
                        <div id="cpu_div" class="list-group-item-text">
                            <!--<p class="pull-left">Intel奔腾G2130</p><span class="pull-right">￥399</span>-->
                            <!--<br/>-->
                        </div>
                    </a>
                    <a href="#" class="list-group-item" onclick="go('主板')">
                        <h4 class="list-group-item-heading">
                            主板
                        </h4>
                        <div id="board_div" class="list-group-item-text">
                            <!--<span class="pic"></span>-->
                        </div>
                    </a>
                    <a href="#" class="list-group-item" onclick="go('内存')">
                        <h4 class="list-group-item-heading">
                            内存
                        </h4>
                        <div id="mem_div" class="list-group-item-text">
                            <!--<span class="pic"></span>-->
                        </div>
                    </a>
                    <a href="#" class="list-group-item" onclick="go('显卡')">
                        <h4 class="list-group-item-heading">
                            显卡
                        </h4>
                        <div id="display_div" class="list-group-item-text">
                            <!--<span class="pic"></span>-->

                        </div>
                    </a>
                    <a href="#" class="list-group-item" onclick="go('电源')">
                        <h4 class="list-group-item-heading">
                            电源
                        </h4>
                        <div id="power_div" class="list-group-item-text">
                            <!--<span class="pic"></span>-->

                        </div>
                    </a>
                    <a href="#" class="list-group-item">
                        <h4 class="list-group-item-heading ">
                            合计
                        </h4>
                        <div id="sum_div" class="list-group-item-text">
                            <!--<span class="pic"></span>-->

                        </div>
                    </a>
                </div>
                <div class="panel-footer">
                    <form role="form">
                        <div class="form-group">
                            <label>描述</label>
                            <textarea class="form-control" id="partTableDescribe" rows="3"></textarea>
                            <br>
                            <button type="submit" id="buttonClick" onclick="postOrder();"
                                    class="btn layui-bg-cyan btn-default">提交
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div id="rightSide" class="col-sm-7">

        </div>
    </div>
    <div class="row">.</div>
    <div class="row">
        <div class="col-sm-5">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        新闻
                    </h3>
                </div>
                <div class="panel-body">
                    <table class="table table-responsive table-hover">
                        <tbody id="newsTbody">

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-sm-7">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        配置单推荐
                    </h3>
                </div>
                <div class="panel-body">
                    <table class="table table-responsive table-hover">
                        <tbody id="partTbody">

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 模态框（Modal） -->
<div class="modal fade" id="myModal1" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel">
                    配件详细参数
                </h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-horizontal">
                            <div class="form-group">
                                <label class="control-label col-md-2">类型</label>
                                <div class="col-md-10">
                                    <p class="control-label" style="text-align: left" id="type"></p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-2">型号</label>
                                <div class="col-md-10">
                                    <p class="control-label" style="text-align: left" id="name"></p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-2">价格</label>
                                <div class="col-md-10">
                                    <p class="control-label" style="text-align: left" id="price"></p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-2">详细参数</label>
                                <div class="col-md-10">
                                    <p class="control-label" style="text-align: left" id="describe"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>
<!-- 模态框（Modal） -->
<div class="modal fade" id="newsModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h3 class="modal-title" id="newsModalLabel">

                </h3>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-horizontal">
                            <div class="form-group">
                                <div class="col-md-12">
                                    <h4 id="newsImage">
                                    </h4>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-md-12">
                                    <h4 id="newsNote">

                                    </h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>
<!-- 模态框（Modal） -->
<div class="modal fade" id="partModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="partModalTitle">
                    订单详情
                </h4>
            </div>
            <div class="modal-body">
                <div class="row">

                    <div class="col-md-12">
                        <div id="modalForm" class="form-horizontal">
                            <div class="form-group">
                                <label class="control-label col-md-2">处理器</label>
                                <div class="col-md-10">
                                    <p class="control-label" style="text-align: left" id="partCpu"></p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-2">主板</label>
                                <div class="col-md-10">
                                    <p class="control-label" style="text-align: left" id="partBoard"></p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-2">内存</label>
                                <div class="col-md-10">
                                    <p class="control-label" style="text-align: left" id="partMemory"></p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-2">电源</label>
                                <div class="col-md-10">
                                    <p class="control-label" style="text-align: left" id="partPower"></p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-2">显卡</label>
                                <div class="col-md-10">
                                    <p class="control-label" style="text-align: left" id="partVga"></p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-2">描述</label>
                                <div class="col-md-10">
                                    <p class="control-label" style="text-align: left" id="partDescribe"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-dismiss="modal">关闭</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>
</body>
<script>
    go('CPU');
    rightDiv = $('#rightSide');
    myModal1 = $("#myModal1");
    partType = $("#type")
    partName = $("#name")
    partPrice = $("#price")
    partDescribe = $("#describe")
    var orderCpu, orderBoard, orderMemory, orderVga, orderPower;
    var cpuPrice = 0, boardPrice = 0, memPrice = 0, vgaPrice = 0, powerPrice = 0, priceSum = 0
    var userId;
    function go(name) {
        switch (name) {
            case 'CPU':
                $.get('cpu.html', function (data) {
                    rightDiv.html(data)
                });
                break;
            case '主板':
                $.get('board.html', function (data) {
                    rightDiv.html(data)
                });
                break;
            case '内存':
                $.get('memory.html', function (data) {
                    rightDiv.html(data)
                });
                break;
            case '显卡':
                $.get('vga.html', function (data) {
                    rightDiv.html(data)
                });
                break;
            case '电源':
                $.get('power.html', function (data) {
                    rightDiv.html(data)
                });
                break;
        }
    }

    $(function () {
        buildImagedv();
        getNewsList();
        getPartList();
        setInterval("checkLogin()", 1 * 500);
    });

    function checkLogin() {
        $.ajax({
            type: "GET",
            url: host + "/user/session",
            xhrFields: {
                withCredentials: true
            },
            success: function (msg) {
                navbarForm = $('#navbar_form')
                if (msg.code == 401) {
                    navbarForm.html("<a class=\"btn btn-default\" href=\"register.html\">\n" +
                        "                注册\n" +
                        "            </a>\n" +
                        "            <a class=\"btn btn-default\" href=\"login.html\">\n" +
                        "                登录\n" +
                        "            </a>")

                }
                if (msg.code == 200) {
                    data = msg.data
                    userAccount = data.userAccount
                    userRole = data.userRole
                    userId = userAccount.userId
                    if(userRole.userRole == 1){
                        navbarForm.html("<a style='margin-right: 20px;' href='user.html'>" + userAccount.userId + "</a>" +
                            "<a class='btn btn-default' onclick='removeSession()'>注销</a>")
                    }else {
                        navbarForm.html("<a style='margin-right: 20px;' href='admin.html'>" + userAccount.userId + "</a>" +
                            "<a class='btn btn-default' onclick='removeSession()'>注销</a>")
                    }

                }
            }
        })
    }

    function removeSession() {
        $.ajax({
            type: "DELETE",
            url: host + "/user/session",
            xhrFields: {
                withCredentials: true
            },
            success: function (msg) {
                window.location.href = "main.html"
            }
        })
    }

    function select(type, name, price, describe, id) {
        o = null
        switch (type) {
            case 'cpu':
                o = $('#cpu_div');
                orderCpu = id;
                if (price != "暂无报价") {
                    numStr = price.split("￥")
                    cpuPrice = parseInt(numStr[1])
                }
                break;
            case 'board':
                o = $('#board_div');
                orderBoard = id
                if (price != "已下市") {
                    numStr = price.split("￥")
                    boardPrice = parseInt(numStr[1])
                }
                break;
            case 'memory':
                o = $('#mem_div');
                orderMemory = id
                if (price != "暂无报价") {
                    numStr = price.split("￥")
                    memPrice = parseInt(numStr[1])
                }
                break;
            case 'vga':
                o = $('#display_div');
                orderVga = id
                if (price != "暂无报价") {
                    numStr = price.split("￥")
                    vgaPrice = parseInt(numStr[1])
                }
                break;
            case 'power':
                o = $('#power_div');
                orderPower = id
                if (price != "暂无报价") {
                    numStr = price.split("￥")
                    powerPrice = parseInt(numStr[1])
                }
                break;
        }
        if (o != null) {
            o.html("<p class=\"pull-left\">" + name + "</p><span class=\"pull-right\">" + price + "</span><br/>");
        }
        priceSum = 0
        priceSum = cpuPrice + boardPrice + memPrice + vgaPrice + powerPrice
        o = $("#sum_div")
        o.html("<span class=\"pull-right\">￥" + priceSum.toString() + "</span><br/>");
        var ss = new Array();
        ss = describe.split("；")
        describe = ""
        ss.forEach(function (item) {
            describe += item + "<br>"
        })
        partType.html(type)
        partName.html(name)
        partPrice.html(price)
        partDescribe.html(describe)
        myModal1.modal('show')
    }

    function postOrder() {
        var partTableDescribe = $("#partTableDescribe").val()
        var computerOrder = {
            price: priceSum
        }

        var computerPart = {
            cpuId: orderCpu,
            boardId: orderBoard,
            memId: orderMemory,
            powerId: orderPower,
            vgaId: orderVga,
            partTableName: userId,
            partTableDescribe: $("#partTableDescribe").val()
        }

        var orderDto = {
            computerPart: computerPart,
            computerOrder: computerOrder
        }

        if(partTableDescribe == "" ||partTableDescribe==null || partTableDescribe == undefined){
            alert("请输入配置单描述")
            return false
        }

        if (confirm("确定提交订单")){
            $.ajax({
                cache: false,
                type: "POST",
                url: host + "/order/order",
                data: JSON.stringify(orderDto),
                contentType: "application/json",
                async: false,
                xhrFields: {
                    withCredentials: true
                },
                success: function (msg) {
                    if (msg.code == 200) {
                        alert(msg.data)
                        window.location.href = "#"
                    }
                    if (msg.code == 400) {
                        alert(msg.data)
                    }
                    if (msg.code == 401) {
                        alert(msg.data)
                    }
                }
            })
            return true
        }else {
            return false
        }

    }

    function buildImagedv() {
        var indicatorsHtml1='',innerHtml1=''
        $.ajax({
            type: "GET",
            url: host + "/news/imagedvList",
            xhrFields: {
                withCredentials: true
            },
            success: function (msg) {
                carouselIndicators = $("#carouselIndicators")
                carouselInner = $("#carouselInner")
                data = msg.data
                for (i in data){
                    if(i==0){
                        indicatorsHtml1 = '<li data-target="#myCarousel" data-slide-to="'+i+'" class="active"></li>'
                        innerHtml1 = '<div class=\"item active\">'
                        innerHtml1 += '<img style="height: 320px;width: 720px" src="'+host+"/news/imagedv/"+data[i].filename+'" class="center-block" alt="First slide">'
                        innerHtml1 +='</div>'
                    }else {
                        indicatorsHtml1 += '<li data-target="#myCarousel" data-slide-to="'+i+'"></li>'
                        innerHtml1 += '<div class=\"item \">'
                        innerHtml1 += '<img style="height: 320px;width: 720px" src="'+host+"/news/imagedv/"+data[i].filename+'" class="center-block" alt="First slide">'
                        innerHtml1 +='</div>'
                    }
                }
                carouselIndicators.html(indicatorsHtml1)
                carouselInner.html(innerHtml1)
            }
        })
    }

    function getNewsList() {
        newsTbody = $('#newsTbody');
        newsTbody.html('');
        $.ajax({
            type: "GET",
            url: host + "/news/news",
            xhrFields: {
                withCredentials: true
            },
            success: function (msg) {
               news = msg.data;
               for (i in news) {
                   newsTitle = news[i].title
                   html = "<tr onclick=\"selectNews('"+newsTitle+"')\">";
                   html += '<td></td>'
                   html += '<td>' + newsTitle + '</td>';
                   html += '</tr>';
                   newsTbody.append(html)
               }

            }
        })
    }

    function getPartList() {
        partTbody = $('#partTbody');
        partTbody.html('');
        $.ajax({
            type: "GET",
            url: host + "/news/parts",
            xhrFields: {
                withCredentials: true
            },
            success: function (msg) {
                parts = msg.data;
                for (i in parts) {
                    partTableDescribe = parts[i].partTableDescribe
                    html = "<tr onclick=\"selectParts('"+parts[i].partTableId+"')\">";
                    html += '<td></td>'
                    html += '<td>' + partTableDescribe + '</td>';
                    html += '</tr>';
                    partTbody.append(html)
                }

            }
        })
    }
    
    function selectNews(newsTitle) {
        newsNote = $("#newsNote")
        newsModalLabel = $("#newsModalLabel")
        newsModal = $("#newsModal")
        newsImage = $("#newsImage")
        $.ajax({
            type: "GET",
            url: host + "/news/news",
            xhrFields: {
                withCredentials: true
            },
            success: function (msg) {
                news = msg.data;
                for (i in news) {
                    title = news[i].title
                    if (newsTitle == title){
                        imageHtml = '<img style="height: 160px;width: 320px" src="'+host+"/news/imagedv/"+news[i].img+'" class="center-block" alt="First slide">'
                        newsNote.html(news[i].note)
                        newsModalLabel.html(title)
                        newsImage.html(imageHtml)
                    }
                }
                newsModal.modal('show')
            }
        })
    }
    
    function selectParts(partTableId) {
        partCpu = $("#partCpu")
        partMemory = $("#partMemory")
        partBoard = $("#partBoard")
        partVga = $("#partVga")
        partPower = $("#partPower")
        partDescribe = $("#partDescribe")
        partModal = $("#partModal")
        // partCpu.html("")
        // partMemory.html("")
        // partBoard.html("")
        // partVga.html("")
        // partPower.html("")
        // partDescribe.html("")
        $.ajax({
            type: "GET",
            url: host + "/news/parts",
            xhrFields: {
                withCredentials: true
            },
            success: function (msg) {
                parts = msg.data;
                for (i in parts) {
                    partTableId1 = parts[i].partTableId
                    if (partTableId == partTableId1){
                        part = parts[i]
                        if(part.cpuId)
                            partCpu.html(getName('CPU', part.cpuId).data.cpuName)
                        if(part.memId)
                            partMemory.html(getName('内存', part.memId).data.memName)
                        if(part.boardId)
                            partBoard.html(getName('主板', part.boardId).data.boardName)
                        if(part.vgaId)
                            partVga.html(getName('显卡', part.vgaId).data.vgaName)
                        if(part.powerId)
                            partPower.html(getName('电源', part.powerId).data.powerName)

                        partDescribe.html(part.partTableDescribe)
                    }
                }
                partModal.modal('show')
            }
        })
    }

    function getName(type, id) {
        return $.ajax({
            type: "post",
            url: host + "/part/get-part",
            data: JSON.stringify({
                part: type,
                searchContent: "" + id
            }),
            contentType: "application/json",
            async: false,
            xhrFields: {
                withCredentials: true
            }
        }).responseJSON;
    }
</script>
</html>